(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){

var ko = require('knockout');
var components = require('ungit-components');
var diff2html = require('diff2html').Diff2Html;
var programEvents = require('ungit-program-events');
var Promise = require("bluebird");

components.register('textdiff', function (args) {
  return new TextDiffViewModel(args);
});

components.register('textdiff.type', function () {
  return new Type();
});

components.register('textdiff.wordwrap', function () {
  return new WordWrap();
});

components.register('textdiff.whitespace', function () {
  return new WhiteSpace();
});

var loadLimit = 100;

var WordWrap = function () {
  var self = this;

  this.text = ko.observable("No Wrap");
  this.value = ko.observable(false);
  this.value.subscribe(function (value) {
    self.text(value ? "Word Wrap" : "No Wrap");
  });
  this.toggle = function () {
    self.value(!self.value());
  }
  this.isActive = ko.computed(function () { return !!self.value(); });
}

var Type = function () {
  var self = this;
  var sideBySideDiff = 'sidebysidediff'
  var textDiff = 'textdiff'

  this.text = ko.observable("Default");

  if (!!ungit.config.diffType && ungit.config.diffType !== 'textdiff' && ungit.config.diffType !== 'sidebysidediff') {
    ungit.config.diffType = 'textdiff';
    console.log('Config "diffType" must be either "textdiff" or "sidebysidediff".');
  }

  this.value = ko.observable(ungit.config.diffType || textDiff);
  this.value.subscribe(function (value) {
    self.text(value === textDiff ? "Default" : "Side By Side");
    programEvents.dispatch({ event: 'invalidate-diff-and-render' });
  });
  this.toggle = function () {
    self.value(self.value() === textDiff ? sideBySideDiff : textDiff);
  }
  this.isActive = ko.computed(function () {
    return self.value() === 'textdiff';
  });
}

var WhiteSpace = function () {
  var self = this;

  this.text = ko.observable("Showing White Space diff");
  this.value = ko.observable(false);
  this.value.subscribe(function (value) {
    self.text(value ? "Ignoring White Space diff" : "Showing White Space diff");
    programEvents.dispatch({ event: 'invalidate-diff-and-render' });
  });
  this.toggle = function () {
    self.value(!self.value());
  }
  this.isActive = ko.computed(function () { return !self.value(); });
}

var TextDiffViewModel = function (args) {
  var self = this;
  this.filename = args.filename;
  this.repoPath = args.repoPath;
  this.server = args.server;
  this.sha1 = args.sha1;
  this.loadMoreCount = ko.observable(0);
  this.diffJson = null;
  this.loadCount = loadLimit;
  this.textDiffType = args.textDiffType;
  this.whiteSpace = args.whiteSpace;
  this.isShowingDiffs = args.isShowingDiffs;
  this.diffProgressBar = args.diffProgressBar;
  this.editState = args.editState;
  this.wordWrap = args.wordWrap;
  this.patchLineList = args.patchLineList;
  this.numberOfSelectedPatchLines = 0;
  this.htmlSrc = undefined;
  this.isParsed = ko.observable(false);

  programEvents.add(function (event) {
    if (event.event === "invalidate-diff-and-render" || event.event === "working-tree-changed") {
      self.invalidateDiff();
      if (self.isShowingDiffs()) self.render();
    }
  });

  this.isShowingDiffs.subscribe(function (newValue) {
    if (newValue) self.render();
  });

  if (this.isShowingDiffs()) { this.render(); }
}
TextDiffViewModel.prototype.updateNode = function (parentElement) {
  ko.renderTemplate('textdiff', this, {}, parentElement);
}
TextDiffViewModel.prototype.getDiffArguments = function () {
  return {
    file: this.filename,
    path: this.repoPath(),
    sha1: this.sha1 ? this.sha1 : '',
    whiteSpace: this.whiteSpace.value()
  };
}

TextDiffViewModel.prototype.invalidateDiff = function () {
  this.diffJson = null;
}

TextDiffViewModel.prototype.getDiffJson = function () {
  var self = this;
  return self.server.getPromise('/diff', self.getDiffArguments()).then(function (diffs) {
    if (typeof diffs == 'string') {
      self.diffJson = diff2html.getJsonFromDiff(diffs);
    }
  }).catch(function (err) {
    // The file existed before but has been removed, but we're trying to get a diff for it
    // Most likely it will just disappear with the next refresh of the staging area
    // so we just ignore the error here
    if (err.errorCode != 'no-such-file') throw err;
  });
}

TextDiffViewModel.prototype.render = function (isInvalidate) {
  var self = this;
  return Promise.resolve().then(function () {
    if (!self.diffJson || isInvalidate) {
      return self.getDiffJson();
    }
  }).then(function () {
    if (!self.diffJson || self.diffJson.length == 0) return; // check if diffs are available (binary files do not support them)
    var lineCount = 0;

    if (!self.diffJson[0].isTrimmed) {
      self.diffJson[0].blocks = self.diffJson[0].blocks.reduce(function (blocks, block) {
        var length = block.lines.length;
        if (lineCount < self.loadCount) {
          block.lines = block.lines.slice(0, self.loadCount - lineCount);
          blocks.push(block);
        }
        lineCount += length;
        return blocks;
      }, []);
    }
    self.diffJson[0].isTrimmed = true;

    self.loadMoreCount(Math.min(loadLimit, Math.max(0, lineCount - self.loadCount)));

    var html;

    if (self.textDiffType.value() === 'sidebysidediff') {
      html = diff2html.getPrettySideBySideHtmlFromJson(self.diffJson);
    } else {
      html = diff2html.getPrettyHtmlFromJson(self.diffJson);
    }

    self.numberOfSelectedPatchLines = 0;
    var index = 0;

    // ko's binding resolution is not recursive, which means below ko.bind refresh method doesn't work for
    // data bind at getPatchCheckBox that is rendered with "html" binding.
    // which is reason why manually updating the html content and refreshing kobinding to have it render...
    if (self.patchLineList) {
      html = html.replace(/<span class="d2h-code-line-[a-z]+">(\+|\-)/g, function (match, capture) {
        if (self.patchLineList()[index] === undefined) {
          self.patchLineList()[index] = true;
        }

        return self.getPatchCheckBox(capture, index, self.patchLineList()[index++]);
      });
    }

    if (html !== self.htmlSrc) {
      // diff has changed since last we displayed and need refresh
      self.htmlSrc = html;
      self.isParsed(false);
      self.isParsed(true);
    }
  });
};

TextDiffViewModel.prototype.loadMore = function () {
  this.loadCount += this.loadMoreCount();
  programEvents.dispatch({ event: 'invalidate-diff-and-render' });
}

TextDiffViewModel.prototype.getPatchCheckBox = function (symbol, index, isActive) {
  if (isActive) {
    this.numberOfSelectedPatchLines++;
  }
  return '<div class="d2h-code-line-prefix"><span data-bind="visible: editState() !== \'patched\'">' + symbol + '</span><input ' + (isActive ? 'checked' : '') + ' type="checkbox" data-bind="visible: editState() === \'patched\', click: togglePatchLine.bind($data, ' + index + ')"></input>';
}

TextDiffViewModel.prototype.togglePatchLine = function (index) {
  this.patchLineList()[index] = !this.patchLineList()[index];

  if (this.patchLineList()[index]) {
    this.numberOfSelectedPatchLines++;
  } else {
    this.numberOfSelectedPatchLines--;
  }

  if (this.numberOfSelectedPatchLines === 0) {
    this.editState('none');
  }

  return true;
}

},{"bluebird":undefined,"diff2html":undefined,"knockout":"knockout","ungit-components":"ungit-components","ungit-program-events":"ungit-program-events"}]},{},[1])
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJjb21wb25lbnRzL3RleHRkaWZmL3RleHRkaWZmLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FDQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6ImdlbmVyYXRlZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24gZSh0LG4scil7ZnVuY3Rpb24gcyhvLHUpe2lmKCFuW29dKXtpZighdFtvXSl7dmFyIGE9dHlwZW9mIHJlcXVpcmU9PVwiZnVuY3Rpb25cIiYmcmVxdWlyZTtpZighdSYmYSlyZXR1cm4gYShvLCEwKTtpZihpKXJldHVybiBpKG8sITApO3ZhciBmPW5ldyBFcnJvcihcIkNhbm5vdCBmaW5kIG1vZHVsZSAnXCIrbytcIidcIik7dGhyb3cgZi5jb2RlPVwiTU9EVUxFX05PVF9GT1VORFwiLGZ9dmFyIGw9bltvXT17ZXhwb3J0czp7fX07dFtvXVswXS5jYWxsKGwuZXhwb3J0cyxmdW5jdGlvbihlKXt2YXIgbj10W29dWzFdW2VdO3JldHVybiBzKG4/bjplKX0sbCxsLmV4cG9ydHMsZSx0LG4scil9cmV0dXJuIG5bb10uZXhwb3J0c312YXIgaT10eXBlb2YgcmVxdWlyZT09XCJmdW5jdGlvblwiJiZyZXF1aXJlO2Zvcih2YXIgbz0wO288ci5sZW5ndGg7bysrKXMocltvXSk7cmV0dXJuIHN9KSIsIlxudmFyIGtvID0gcmVxdWlyZSgna25vY2tvdXQnKTtcbnZhciBjb21wb25lbnRzID0gcmVxdWlyZSgndW5naXQtY29tcG9uZW50cycpO1xudmFyIGRpZmYyaHRtbCA9IHJlcXVpcmUoJ2RpZmYyaHRtbCcpLkRpZmYySHRtbDtcbnZhciBwcm9ncmFtRXZlbnRzID0gcmVxdWlyZSgndW5naXQtcHJvZ3JhbS1ldmVudHMnKTtcbnZhciBQcm9taXNlID0gcmVxdWlyZShcImJsdWViaXJkXCIpO1xuXG5jb21wb25lbnRzLnJlZ2lzdGVyKCd0ZXh0ZGlmZicsIGZ1bmN0aW9uIChhcmdzKSB7XG4gIHJldHVybiBuZXcgVGV4dERpZmZWaWV3TW9kZWwoYXJncyk7XG59KTtcblxuY29tcG9uZW50cy5yZWdpc3RlcigndGV4dGRpZmYudHlwZScsIGZ1bmN0aW9uICgpIHtcbiAgcmV0dXJuIG5ldyBUeXBlKCk7XG59KTtcblxuY29tcG9uZW50cy5yZWdpc3RlcigndGV4dGRpZmYud29yZHdyYXAnLCBmdW5jdGlvbiAoKSB7XG4gIHJldHVybiBuZXcgV29yZFdyYXAoKTtcbn0pO1xuXG5jb21wb25lbnRzLnJlZ2lzdGVyKCd0ZXh0ZGlmZi53aGl0ZXNwYWNlJywgZnVuY3Rpb24gKCkge1xuICByZXR1cm4gbmV3IFdoaXRlU3BhY2UoKTtcbn0pO1xuXG52YXIgbG9hZExpbWl0ID0gMTAwO1xuXG52YXIgV29yZFdyYXAgPSBmdW5jdGlvbiAoKSB7XG4gIHZhciBzZWxmID0gdGhpcztcblxuICB0aGlzLnRleHQgPSBrby5vYnNlcnZhYmxlKFwiTm8gV3JhcFwiKTtcbiAgdGhpcy52YWx1ZSA9IGtvLm9ic2VydmFibGUoZmFsc2UpO1xuICB0aGlzLnZhbHVlLnN1YnNjcmliZShmdW5jdGlvbiAodmFsdWUpIHtcbiAgICBzZWxmLnRleHQodmFsdWUgPyBcIldvcmQgV3JhcFwiIDogXCJObyBXcmFwXCIpO1xuICB9KTtcbiAgdGhpcy50b2dnbGUgPSBmdW5jdGlvbiAoKSB7XG4gICAgc2VsZi52YWx1ZSghc2VsZi52YWx1ZSgpKTtcbiAgfVxuICB0aGlzLmlzQWN0aXZlID0ga28uY29tcHV0ZWQoZnVuY3Rpb24gKCkgeyByZXR1cm4gISFzZWxmLnZhbHVlKCk7IH0pO1xufVxuXG52YXIgVHlwZSA9IGZ1bmN0aW9uICgpIHtcbiAgdmFyIHNlbGYgPSB0aGlzO1xuICB2YXIgc2lkZUJ5U2lkZURpZmYgPSAnc2lkZWJ5c2lkZWRpZmYnXG4gIHZhciB0ZXh0RGlmZiA9ICd0ZXh0ZGlmZidcblxuICB0aGlzLnRleHQgPSBrby5vYnNlcnZhYmxlKFwiRGVmYXVsdFwiKTtcblxuICBpZiAoISF1bmdpdC5jb25maWcuZGlmZlR5cGUgJiYgdW5naXQuY29uZmlnLmRpZmZUeXBlICE9PSAndGV4dGRpZmYnICYmIHVuZ2l0LmNvbmZpZy5kaWZmVHlwZSAhPT0gJ3NpZGVieXNpZGVkaWZmJykge1xuICAgIHVuZ2l0LmNvbmZpZy5kaWZmVHlwZSA9ICd0ZXh0ZGlmZic7XG4gICAgY29uc29sZS5sb2coJ0NvbmZpZyBcImRpZmZUeXBlXCIgbXVzdCBiZSBlaXRoZXIgXCJ0ZXh0ZGlmZlwiIG9yIFwic2lkZWJ5c2lkZWRpZmZcIi4nKTtcbiAgfVxuXG4gIHRoaXMudmFsdWUgPSBrby5vYnNlcnZhYmxlKHVuZ2l0LmNvbmZpZy5kaWZmVHlwZSB8fCB0ZXh0RGlmZik7XG4gIHRoaXMudmFsdWUuc3Vic2NyaWJlKGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgIHNlbGYudGV4dCh2YWx1ZSA9PT0gdGV4dERpZmYgPyBcIkRlZmF1bHRcIiA6IFwiU2lkZSBCeSBTaWRlXCIpO1xuICAgIHByb2dyYW1FdmVudHMuZGlzcGF0Y2goeyBldmVudDogJ2ludmFsaWRhdGUtZGlmZi1hbmQtcmVuZGVyJyB9KTtcbiAgfSk7XG4gIHRoaXMudG9nZ2xlID0gZnVuY3Rpb24gKCkge1xuICAgIHNlbGYudmFsdWUoc2VsZi52YWx1ZSgpID09PSB0ZXh0RGlmZiA/IHNpZGVCeVNpZGVEaWZmIDogdGV4dERpZmYpO1xuICB9XG4gIHRoaXMuaXNBY3RpdmUgPSBrby5jb21wdXRlZChmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHNlbGYudmFsdWUoKSA9PT0gJ3RleHRkaWZmJztcbiAgfSk7XG59XG5cbnZhciBXaGl0ZVNwYWNlID0gZnVuY3Rpb24gKCkge1xuICB2YXIgc2VsZiA9IHRoaXM7XG5cbiAgdGhpcy50ZXh0ID0ga28ub2JzZXJ2YWJsZShcIlNob3dpbmcgV2hpdGUgU3BhY2UgZGlmZlwiKTtcbiAgdGhpcy52YWx1ZSA9IGtvLm9ic2VydmFibGUoZmFsc2UpO1xuICB0aGlzLnZhbHVlLnN1YnNjcmliZShmdW5jdGlvbiAodmFsdWUpIHtcbiAgICBzZWxmLnRleHQodmFsdWUgPyBcIklnbm9yaW5nIFdoaXRlIFNwYWNlIGRpZmZcIiA6IFwiU2hvd2luZyBXaGl0ZSBTcGFjZSBkaWZmXCIpO1xuICAgIHByb2dyYW1FdmVudHMuZGlzcGF0Y2goeyBldmVudDogJ2ludmFsaWRhdGUtZGlmZi1hbmQtcmVuZGVyJyB9KTtcbiAgfSk7XG4gIHRoaXMudG9nZ2xlID0gZnVuY3Rpb24gKCkge1xuICAgIHNlbGYudmFsdWUoIXNlbGYudmFsdWUoKSk7XG4gIH1cbiAgdGhpcy5pc0FjdGl2ZSA9IGtvLmNvbXB1dGVkKGZ1bmN0aW9uICgpIHsgcmV0dXJuICFzZWxmLnZhbHVlKCk7IH0pO1xufVxuXG52YXIgVGV4dERpZmZWaWV3TW9kZWwgPSBmdW5jdGlvbiAoYXJncykge1xuICB2YXIgc2VsZiA9IHRoaXM7XG4gIHRoaXMuZmlsZW5hbWUgPSBhcmdzLmZpbGVuYW1lO1xuICB0aGlzLnJlcG9QYXRoID0gYXJncy5yZXBvUGF0aDtcbiAgdGhpcy5zZXJ2ZXIgPSBhcmdzLnNlcnZlcjtcbiAgdGhpcy5zaGExID0gYXJncy5zaGExO1xuICB0aGlzLmxvYWRNb3JlQ291bnQgPSBrby5vYnNlcnZhYmxlKDApO1xuICB0aGlzLmRpZmZKc29uID0gbnVsbDtcbiAgdGhpcy5sb2FkQ291bnQgPSBsb2FkTGltaXQ7XG4gIHRoaXMudGV4dERpZmZUeXBlID0gYXJncy50ZXh0RGlmZlR5cGU7XG4gIHRoaXMud2hpdGVTcGFjZSA9IGFyZ3Mud2hpdGVTcGFjZTtcbiAgdGhpcy5pc1Nob3dpbmdEaWZmcyA9IGFyZ3MuaXNTaG93aW5nRGlmZnM7XG4gIHRoaXMuZGlmZlByb2dyZXNzQmFyID0gYXJncy5kaWZmUHJvZ3Jlc3NCYXI7XG4gIHRoaXMuZWRpdFN0YXRlID0gYXJncy5lZGl0U3RhdGU7XG4gIHRoaXMud29yZFdyYXAgPSBhcmdzLndvcmRXcmFwO1xuICB0aGlzLnBhdGNoTGluZUxpc3QgPSBhcmdzLnBhdGNoTGluZUxpc3Q7XG4gIHRoaXMubnVtYmVyT2ZTZWxlY3RlZFBhdGNoTGluZXMgPSAwO1xuICB0aGlzLmh0bWxTcmMgPSB1bmRlZmluZWQ7XG4gIHRoaXMuaXNQYXJzZWQgPSBrby5vYnNlcnZhYmxlKGZhbHNlKTtcblxuICBwcm9ncmFtRXZlbnRzLmFkZChmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICBpZiAoZXZlbnQuZXZlbnQgPT09IFwiaW52YWxpZGF0ZS1kaWZmLWFuZC1yZW5kZXJcIiB8fCBldmVudC5ldmVudCA9PT0gXCJ3b3JraW5nLXRyZWUtY2hhbmdlZFwiKSB7XG4gICAgICBzZWxmLmludmFsaWRhdGVEaWZmKCk7XG4gICAgICBpZiAoc2VsZi5pc1Nob3dpbmdEaWZmcygpKSBzZWxmLnJlbmRlcigpO1xuICAgIH1cbiAgfSk7XG5cbiAgdGhpcy5pc1Nob3dpbmdEaWZmcy5zdWJzY3JpYmUoZnVuY3Rpb24gKG5ld1ZhbHVlKSB7XG4gICAgaWYgKG5ld1ZhbHVlKSBzZWxmLnJlbmRlcigpO1xuICB9KTtcblxuICBpZiAodGhpcy5pc1Nob3dpbmdEaWZmcygpKSB7IHRoaXMucmVuZGVyKCk7IH1cbn1cblRleHREaWZmVmlld01vZGVsLnByb3RvdHlwZS51cGRhdGVOb2RlID0gZnVuY3Rpb24gKHBhcmVudEVsZW1lbnQpIHtcbiAga28ucmVuZGVyVGVtcGxhdGUoJ3RleHRkaWZmJywgdGhpcywge30sIHBhcmVudEVsZW1lbnQpO1xufVxuVGV4dERpZmZWaWV3TW9kZWwucHJvdG90eXBlLmdldERpZmZBcmd1bWVudHMgPSBmdW5jdGlvbiAoKSB7XG4gIHJldHVybiB7XG4gICAgZmlsZTogdGhpcy5maWxlbmFtZSxcbiAgICBwYXRoOiB0aGlzLnJlcG9QYXRoKCksXG4gICAgc2hhMTogdGhpcy5zaGExID8gdGhpcy5zaGExIDogJycsXG4gICAgd2hpdGVTcGFjZTogdGhpcy53aGl0ZVNwYWNlLnZhbHVlKClcbiAgfTtcbn1cblxuVGV4dERpZmZWaWV3TW9kZWwucHJvdG90eXBlLmludmFsaWRhdGVEaWZmID0gZnVuY3Rpb24gKCkge1xuICB0aGlzLmRpZmZKc29uID0gbnVsbDtcbn1cblxuVGV4dERpZmZWaWV3TW9kZWwucHJvdG90eXBlLmdldERpZmZKc29uID0gZnVuY3Rpb24gKCkge1xuICB2YXIgc2VsZiA9IHRoaXM7XG4gIHJldHVybiBzZWxmLnNlcnZlci5nZXRQcm9taXNlKCcvZGlmZicsIHNlbGYuZ2V0RGlmZkFyZ3VtZW50cygpKS50aGVuKGZ1bmN0aW9uIChkaWZmcykge1xuICAgIGlmICh0eXBlb2YgZGlmZnMgPT0gJ3N0cmluZycpIHtcbiAgICAgIHNlbGYuZGlmZkpzb24gPSBkaWZmMmh0bWwuZ2V0SnNvbkZyb21EaWZmKGRpZmZzKTtcbiAgICB9XG4gIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHtcbiAgICAvLyBUaGUgZmlsZSBleGlzdGVkIGJlZm9yZSBidXQgaGFzIGJlZW4gcmVtb3ZlZCwgYnV0IHdlJ3JlIHRyeWluZyB0byBnZXQgYSBkaWZmIGZvciBpdFxuICAgIC8vIE1vc3QgbGlrZWx5IGl0IHdpbGwganVzdCBkaXNhcHBlYXIgd2l0aCB0aGUgbmV4dCByZWZyZXNoIG9mIHRoZSBzdGFnaW5nIGFyZWFcbiAgICAvLyBzbyB3ZSBqdXN0IGlnbm9yZSB0aGUgZXJyb3IgaGVyZVxuICAgIGlmIChlcnIuZXJyb3JDb2RlICE9ICduby1zdWNoLWZpbGUnKSB0aHJvdyBlcnI7XG4gIH0pO1xufVxuXG5UZXh0RGlmZlZpZXdNb2RlbC5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24gKGlzSW52YWxpZGF0ZSkge1xuICB2YXIgc2VsZiA9IHRoaXM7XG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUoKS50aGVuKGZ1bmN0aW9uICgpIHtcbiAgICBpZiAoIXNlbGYuZGlmZkpzb24gfHwgaXNJbnZhbGlkYXRlKSB7XG4gICAgICByZXR1cm4gc2VsZi5nZXREaWZmSnNvbigpO1xuICAgIH1cbiAgfSkudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgaWYgKCFzZWxmLmRpZmZKc29uIHx8IHNlbGYuZGlmZkpzb24ubGVuZ3RoID09IDApIHJldHVybjsgLy8gY2hlY2sgaWYgZGlmZnMgYXJlIGF2YWlsYWJsZSAoYmluYXJ5IGZpbGVzIGRvIG5vdCBzdXBwb3J0IHRoZW0pXG4gICAgdmFyIGxpbmVDb3VudCA9IDA7XG5cbiAgICBpZiAoIXNlbGYuZGlmZkpzb25bMF0uaXNUcmltbWVkKSB7XG4gICAgICBzZWxmLmRpZmZKc29uWzBdLmJsb2NrcyA9IHNlbGYuZGlmZkpzb25bMF0uYmxvY2tzLnJlZHVjZShmdW5jdGlvbiAoYmxvY2tzLCBibG9jaykge1xuICAgICAgICB2YXIgbGVuZ3RoID0gYmxvY2subGluZXMubGVuZ3RoO1xuICAgICAgICBpZiAobGluZUNvdW50IDwgc2VsZi5sb2FkQ291bnQpIHtcbiAgICAgICAgICBibG9jay5saW5lcyA9IGJsb2NrLmxpbmVzLnNsaWNlKDAsIHNlbGYubG9hZENvdW50IC0gbGluZUNvdW50KTtcbiAgICAgICAgICBibG9ja3MucHVzaChibG9jayk7XG4gICAgICAgIH1cbiAgICAgICAgbGluZUNvdW50ICs9IGxlbmd0aDtcbiAgICAgICAgcmV0dXJuIGJsb2NrcztcbiAgICAgIH0sIFtdKTtcbiAgICB9XG4gICAgc2VsZi5kaWZmSnNvblswXS5pc1RyaW1tZWQgPSB0cnVlO1xuXG4gICAgc2VsZi5sb2FkTW9yZUNvdW50KE1hdGgubWluKGxvYWRMaW1pdCwgTWF0aC5tYXgoMCwgbGluZUNvdW50IC0gc2VsZi5sb2FkQ291bnQpKSk7XG5cbiAgICB2YXIgaHRtbDtcblxuICAgIGlmIChzZWxmLnRleHREaWZmVHlwZS52YWx1ZSgpID09PSAnc2lkZWJ5c2lkZWRpZmYnKSB7XG4gICAgICBodG1sID0gZGlmZjJodG1sLmdldFByZXR0eVNpZGVCeVNpZGVIdG1sRnJvbUpzb24oc2VsZi5kaWZmSnNvbik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGh0bWwgPSBkaWZmMmh0bWwuZ2V0UHJldHR5SHRtbEZyb21Kc29uKHNlbGYuZGlmZkpzb24pO1xuICAgIH1cblxuICAgIHNlbGYubnVtYmVyT2ZTZWxlY3RlZFBhdGNoTGluZXMgPSAwO1xuICAgIHZhciBpbmRleCA9IDA7XG5cbiAgICAvLyBrbydzIGJpbmRpbmcgcmVzb2x1dGlvbiBpcyBub3QgcmVjdXJzaXZlLCB3aGljaCBtZWFucyBiZWxvdyBrby5iaW5kIHJlZnJlc2ggbWV0aG9kIGRvZXNuJ3Qgd29yayBmb3JcbiAgICAvLyBkYXRhIGJpbmQgYXQgZ2V0UGF0Y2hDaGVja0JveCB0aGF0IGlzIHJlbmRlcmVkIHdpdGggXCJodG1sXCIgYmluZGluZy5cbiAgICAvLyB3aGljaCBpcyByZWFzb24gd2h5IG1hbnVhbGx5IHVwZGF0aW5nIHRoZSBodG1sIGNvbnRlbnQgYW5kIHJlZnJlc2hpbmcga29iaW5kaW5nIHRvIGhhdmUgaXQgcmVuZGVyLi4uXG4gICAgaWYgKHNlbGYucGF0Y2hMaW5lTGlzdCkge1xuICAgICAgaHRtbCA9IGh0bWwucmVwbGFjZSgvPHNwYW4gY2xhc3M9XCJkMmgtY29kZS1saW5lLVthLXpdK1wiPihcXCt8XFwtKS9nLCBmdW5jdGlvbiAobWF0Y2gsIGNhcHR1cmUpIHtcbiAgICAgICAgaWYgKHNlbGYucGF0Y2hMaW5lTGlzdCgpW2luZGV4XSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgc2VsZi5wYXRjaExpbmVMaXN0KClbaW5kZXhdID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBzZWxmLmdldFBhdGNoQ2hlY2tCb3goY2FwdHVyZSwgaW5kZXgsIHNlbGYucGF0Y2hMaW5lTGlzdCgpW2luZGV4KytdKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChodG1sICE9PSBzZWxmLmh0bWxTcmMpIHtcbiAgICAgIC8vIGRpZmYgaGFzIGNoYW5nZWQgc2luY2UgbGFzdCB3ZSBkaXNwbGF5ZWQgYW5kIG5lZWQgcmVmcmVzaFxuICAgICAgc2VsZi5odG1sU3JjID0gaHRtbDtcbiAgICAgIHNlbGYuaXNQYXJzZWQoZmFsc2UpO1xuICAgICAgc2VsZi5pc1BhcnNlZCh0cnVlKTtcbiAgICB9XG4gIH0pO1xufTtcblxuVGV4dERpZmZWaWV3TW9kZWwucHJvdG90eXBlLmxvYWRNb3JlID0gZnVuY3Rpb24gKCkge1xuICB0aGlzLmxvYWRDb3VudCArPSB0aGlzLmxvYWRNb3JlQ291bnQoKTtcbiAgcHJvZ3JhbUV2ZW50cy5kaXNwYXRjaCh7IGV2ZW50OiAnaW52YWxpZGF0ZS1kaWZmLWFuZC1yZW5kZXInIH0pO1xufVxuXG5UZXh0RGlmZlZpZXdNb2RlbC5wcm90b3R5cGUuZ2V0UGF0Y2hDaGVja0JveCA9IGZ1bmN0aW9uIChzeW1ib2wsIGluZGV4LCBpc0FjdGl2ZSkge1xuICBpZiAoaXNBY3RpdmUpIHtcbiAgICB0aGlzLm51bWJlck9mU2VsZWN0ZWRQYXRjaExpbmVzKys7XG4gIH1cbiAgcmV0dXJuICc8ZGl2IGNsYXNzPVwiZDJoLWNvZGUtbGluZS1wcmVmaXhcIj48c3BhbiBkYXRhLWJpbmQ9XCJ2aXNpYmxlOiBlZGl0U3RhdGUoKSAhPT0gXFwncGF0Y2hlZFxcJ1wiPicgKyBzeW1ib2wgKyAnPC9zcGFuPjxpbnB1dCAnICsgKGlzQWN0aXZlID8gJ2NoZWNrZWQnIDogJycpICsgJyB0eXBlPVwiY2hlY2tib3hcIiBkYXRhLWJpbmQ9XCJ2aXNpYmxlOiBlZGl0U3RhdGUoKSA9PT0gXFwncGF0Y2hlZFxcJywgY2xpY2s6IHRvZ2dsZVBhdGNoTGluZS5iaW5kKCRkYXRhLCAnICsgaW5kZXggKyAnKVwiPjwvaW5wdXQ+Jztcbn1cblxuVGV4dERpZmZWaWV3TW9kZWwucHJvdG90eXBlLnRvZ2dsZVBhdGNoTGluZSA9IGZ1bmN0aW9uIChpbmRleCkge1xuICB0aGlzLnBhdGNoTGluZUxpc3QoKVtpbmRleF0gPSAhdGhpcy5wYXRjaExpbmVMaXN0KClbaW5kZXhdO1xuXG4gIGlmICh0aGlzLnBhdGNoTGluZUxpc3QoKVtpbmRleF0pIHtcbiAgICB0aGlzLm51bWJlck9mU2VsZWN0ZWRQYXRjaExpbmVzKys7XG4gIH0gZWxzZSB7XG4gICAgdGhpcy5udW1iZXJPZlNlbGVjdGVkUGF0Y2hMaW5lcy0tO1xuICB9XG5cbiAgaWYgKHRoaXMubnVtYmVyT2ZTZWxlY3RlZFBhdGNoTGluZXMgPT09IDApIHtcbiAgICB0aGlzLmVkaXRTdGF0ZSgnbm9uZScpO1xuICB9XG5cbiAgcmV0dXJuIHRydWU7XG59XG4iXX0=
